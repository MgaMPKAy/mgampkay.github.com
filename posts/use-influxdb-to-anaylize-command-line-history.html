<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>MgaMPKAy's 用InfluxDB分析命令行历史</title>
    <link rel="stylesheet" type="text/css" href="../css/default.css" />
  </head>
  <body>
    <header id="header">
      <div id="logo">
        <a href="../">MgaMPKAy's Blog</a>
      </div>
      <nav id="navigation">
        <a href="../">Home</a>
        <a href="../about.html">About</a>
        <a href="../archive.html">Archive</a>
      </nav>
    </header>

    <div id="content">
      <h1>用InfluxDB分析命令行历史</h1>

      <article>
  <div class="info">August 24, 2014</div>

  <section id="article-content">
    <p>不务（误）正业系列。</p>
<h1 id="influxdb介绍">InfluxDB介绍</h1>
<p>直接引用InfluxDB官网的一句话：</p>
<blockquote>
<p>InfluxDB is a time series, events, and metrics database.</p>
</blockquote>
<h1 id="导入数据">导入数据</h1>
<p>最喜欢InfluxDB这种开箱即用的软件，安装太简单就不说了，直接进入导入数据的环节。</p>
<p>因为我设了<code>HISTTIMEFORMAT='%F %T '</code>，我的历史记录看起来是这样的：</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># 1408842714</span>
<span class="kw">busybox</span> rpm2cpio influxdb-latest-1.x86_64.rpm <span class="kw">|</span> <span class="kw">busybox</span> cpio -it</code></pre>
<p>已经有了Unix时间戳和完整的命令，只要用<code>language-sh</code>解析一下命令，<a href="http://mgampkay.github.io/posts/some-statics-of-my-command-history.html#%E5%AE%9E%E7%8E%B0">提取出命令名</a>就可以了。</p>
<p>完整的导入脚本在<a href="https://gist.github.com/MgaMPKAy/e0145b103a5a76428efa">Gist</a>，我现在有7万多条原始记录，导入用了15秒，InfluxDB很快但是命令解析太慢。</p>
<h1 id="查询">查询</h1>
<h2 id="每天使用量">每天使用量</h2>
<pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">select</span> <span class="fu">count</span>(command) <span class="kw">as</span> <span class="kw">ALL</span>, <span class="fu">count</span>(<span class="kw">distinct</span>(command)) <span class="kw">as</span> <span class="kw">DISTINCT</span>
   <span class="kw">from</span> commands <span class="kw">where</span> <span class="dt">time</span> &gt; <span class="st">'2014-02-06'</span>  <span class="kw">group</span> <span class="kw">by</span> <span class="dt">time</span>(1d)</code></pre>
<p><svg width="600" height="150" viewBox="0 0 970 200"><g transform="translate(50,10)"><g class="x axis" transform="translate(0,160)"><g class="tick" transform="translate(104.79061976549414,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text y="9" x="0" dy=".71em" style="text-anchor: middle;">March</text></g><g class="tick" transform="translate(248.10720268006702,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text y="9" x="0" dy=".71em" style="text-anchor: middle;">April</text></g><g class="tick" transform="translate(386.8006700167504,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text y="9" x="0" dy=".71em" style="text-anchor: middle;">May</text></g><g class="tick" transform="translate(530.1172529313233,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text y="9" x="0" dy=".71em" style="text-anchor: middle;">June</text></g><g class="tick" transform="translate(668.8107202680067,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text y="9" x="0" dy=".71em" style="text-anchor: middle;">July</text></g><g class="tick" transform="translate(812.1273031825796,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text y="9" x="0" dy=".71em" style="text-anchor: middle;">August</text></g><path class="domain" d="M0,6V0H920V6"></path></g><g class="y axis"><g class="tick" transform="translate(0,139.8451794510908)" style="opacity: 1;"><line x2="-6" y2="0"></line><text x="-9" y="0" dy=".32em" style="text-anchor: end;">200</text></g><g class="tick" transform="translate(0,117.32582688247713)" style="opacity: 1;"><line x2="-6" y2="0"></line><text x="-9" y="0" dy=".32em" style="text-anchor: end;">400</text></g><g class="tick" transform="translate(0,94.80647431386348)" style="opacity: 1;"><line x2="-6" y2="0"></line><text x="-9" y="0" dy=".32em" style="text-anchor: end;">600</text></g><g class="tick" transform="translate(0,72.28712174524983)" style="opacity: 1;"><line x2="-6" y2="0"></line><text x="-9" y="0" dy=".32em" style="text-anchor: end;">800</text></g><g class="tick" transform="translate(0,49.767769176636165)" style="opacity: 1;"><line x2="-6" y2="0"></line><text x="-9" y="0" dy=".32em" style="text-anchor: end;">1.0k</text></g><g class="tick" transform="translate(0,27.248416608022524)" style="opacity: 1;"><line x2="-6" y2="0"></line><text x="-9" y="0" dy=".32em" style="text-anchor: end;">1.2k</text></g><g class="tick" transform="translate(0,4.729064039408854)" style="opacity: 1;"><line x2="-6" y2="0"></line><text x="-9" y="0" dy=".32em" style="text-anchor: end;">1.4k</text></g><path class="domain" d="M-6,0H0V160H-6"></path></g><text class="y label" text-anchor="end" y="6" dy=".75em" transform="rotate(-90)">ALL</text><path class="line" d="M920,142.5475017593244L915.3768844221105,129.71147079521464L910.7537688442211,109.89444053483463L906.1306532663317,134.32793807178044L901.5075376884422,143.11048557353976L896.8844221105528,77.24137931034483L892.2613065326633,125.09500351864884L887.6381909547738,139.95777621393384L883.0150753768845,86.47431386347643L878.391959798995,90.75299085151302L873.7688442211055,0L869.1457286432161,123.63124560168896L864.5226130653266,141.75932441942294L859.8994974874372,145.4750175932442L855.2763819095478,145.58761435608727L850.6532663316583,156.3969035890218L846.0301507537688,93.23011963406051L841.4070351758794,119.57776213933849L836.78391959799,110.11963406052075L832.1608040201005,131.40042223786065L827.5376884422111,98.52216748768473L822.9145728643216,153.2441942294159L818.2914572864321,148.17733990147784L813.6683417085428,131.6256157635468L809.0452261306533,104.26460239268121L804.4221105527638,91.09078114004222L799.7989949748744,127.12174524982407L795.1758793969849,96.4954257565095L790.5527638190955,124.30682617874737L785.9296482412061,95.70724841660802L781.3065326633166,108.76847290640394L776.6834170854271,105.05277973258269L772.0603015075377,103.70161857846587L767.4371859296483,115.07389162561577L762.8140703517588,107.07952146375791L758.1909547738694,130.72484166080227L753.5678391959799,152.34342012667136L748.9447236180904,104.71498944405349L744.321608040201,109.10626319493315L739.6984924623116,51.7945109078114L735.0753768844221,125.43279380717804L730.4522613065327,128.8106966924701L725.8291457286432,125.32019704433498L721.2060301507537,146.1505981703026L716.5829145728644,121.37931034482759L711.9597989949749,88.61365235749473L707.3366834170854,66.65728360309642L702.713567839196,73.75087966220971L698.0904522613065,81.52005629838142L693.4673366834171,154.14496833216046L688.8442211055277,125.09500351864884L684.2211055276382,114.06052076002814L679.5979899497487,113.94792399718509L674.9748743718593,127.6847290640394L670.3517587939699,38.84588318085855L665.7286432160804,55.17241379310346L661.105527638191,144.46164672765659L656.4824120603015,140.29556650246306L651.859296482412,107.75510204081633L647.2361809045227,17.677691766361704L642.6130653266332,78.93033075299086L637.9899497487437,12.160450387051384L633.3668341708543,133.31456720619283L628.7437185929648,139.95777621393384L624.1206030150754,151.5552427867699L619.497487437186,133.53976073187897L614.8743718592965,152.11822660098522L610.251256281407,133.0893736805067L605.6281407035176,151.780436312456L601.0050251256282,144.68684025334272L596.3819095477387,125.32019704433498L591.7587939698493,114.39831104855736L587.1356783919598,132.41379310344828L582.5125628140703,102.01266713581985L577.8894472361809,134.1027445460943L573.2663316582915,129.03589021815623L568.643216080402,138.0436312456017L564.0201005025126,131.51301900070374L559.3969849246231,107.07952146375791L554.7738693467337,128.69809992962703L550.1507537688442,154.7079521463758L545.5276381909548,156.0591133004926L540.9045226130653,137.36805066854328L536.2814070351759,128.3603096410978L531.6582914572864,149.64109781843771L527.035175879397,152.79380717804364L522.4120603015076,152.00562983814214L517.7889447236181,149.41590429275158L513.1658291457286,144.12385643912737L508.54271356783914,140.97114707952147L503.9195979899498,119.80295566502463L499.2964824120603,135.00351864883885L494.67336683417085,140.40816326530611L490.0502512562814,137.7058409570725L485.4271356783919,111.13300492610837L480.80402010050256,81.40745953553835L476.1809045226131,134.66572836030963L471.5577889447236,132.52638986629134L466.93467336683415,125.32019704433498L462.3115577889447,117.21323011963406L457.68844221105525,135.67909922589726L453.06532663316585,64.51794510907811L448.4422110552764,104.82758620689654L443.8190954773869,137.81843771991555L439.1959798994975,130.04926108374383L434.57286432160805,131.17522871217452L429.9497487437186,128.58550316678395L425.32663316582915,106.17874736101336L420.7035175879397,145.8128078817734L416.08040201005025,108.65587614356087L411.4572864321608,110.68261787473611L406.8341708542714,129.4862772695285L402.2110552763819,160L388.34170854271355,133.65235749472203L383.71859296482415,153.2441942294159L379.0954773869347,121.49190710767066L374.4723618090452,138.0436312456017L369.8492462311558,114.39831104855736L365.22613065326635,138.7192118226601L360.60301507537685,143.11048557353976L355.97989949748745,85.68613652357496L351.356783919598,75.2146375791696L346.73366834170855,102.23786066150598L342.1105527638191,148.6277269528501L337.48743718592965,103.02603800140746L332.8643216080402,77.3539760731879L328.24120603015075,94.6938775510204L323.61809045226136,111.80858550316678L318.99497487437185,50.21815622800844L314.3718592964824,92.21674876847291L309.748743718593,96.04503870513723L305.1256281407035,76.67839549612948L300.5025125628141,57.987332864180146L295.87939698492465,98.29697396199859L291.25628140703515,31.07670654468683L286.63316582914575,96.94581280788177L282.0100502512563,131.73821252638987L277.38693467336685,141.1963406052076L272.7638190954774,142.77269528501057L268.14070351758795,66.99507389162562L263.5175879396985,100.43631245601688L258.89447236180905,126.6713581984518L254.27135678391957,138.38142153413088L249.64824120603015,135.9042927515834L245.0251256281407,136.35467980295567L240.40201005025128,98.85995777621393L235.7788944723618,109.44405348346235L231.15577889447235,133.4271639690359L226.53266331658293,127.90992258972554L221.90954773869345,140.8585503166784L217.28643216080403,114.73610133708655L212.66331658291458,139.61998592540465L208.04020100502512,31.301900070372966L203.4170854271357,143.89866291344123L198.79396984924622,148.74032371569317L194.17085427135677,112.59676284306826L189.54773869346735,128.8106966924701L184.9246231155779,152.9064039408867L180.30150753768842,127.34693877551021L175.678391959799,114.06052076002814L171.05527638190955,104.26460239268121L166.4321608040201,132.9767769176636L161.80904522613068,150.7670654468684L157.1859296482412,126.6713581984518L152.56281407035175,93.00492610837439L147.93969849246233,140.29556650246306L143.31658291457288,122.28008444757214L138.69346733668343,110.79521463757916L134.07035175879398,97.84658691062631L129.44723618090453,121.15411681914145L124.82412060301507,129.82406755805772L120.20100502512564,131.06263194933146L115.57788944723617,111.24560168895144L110.95477386934672,128.02251935256862L106.33165829145729,128.58550316678395L101.70854271356785,121.60450387051372L97.08542713567839,112.70935960591133L92.46231155778895,79.38071780436312L87.8391959798995,42.44897959183673L83.21608040201005,102.46305418719211L78.5929648241206,47.29064039408867L73.96984924623116,32.42786769880367L69.34673366834171,136.80506685432795L64.72361809045226,83.32160450387052L60.10050251256282,117.55102040816325L55.47738693467336,132.41379310344828L50.854271356783926,109.33145672061929L46.231155778894475,132.86418015482056L41.608040201005025,115.52427867698805L36.98492462311558,129.4862772695285L32.36180904522613,153.91977480647432L27.73869346733668,126.89655172413794L23.115577889447238,134.44053483462352L18.49246231155779,113.49753694581281L13.86934673366834,119.80295566502463L9.246231155778895,104.26460239268121L4.623115577889448,142.3223082336383L0,127.57213230119635"></path></g></svg></p>
<p><svg width="600" height="150" viewBox="0 0 970 200"><g transform="translate(50,10)"><g class="x axis" transform="translate(0,160)"><g class="tick" transform="translate(104.79061976549414,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text y="9" x="0" dy=".71em" style="text-anchor: middle;">March</text></g><g class="tick" transform="translate(248.10720268006702,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text y="9" x="0" dy=".71em" style="text-anchor: middle;">April</text></g><g class="tick" transform="translate(386.8006700167504,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text y="9" x="0" dy=".71em" style="text-anchor: middle;">May</text></g><g class="tick" transform="translate(530.1172529313233,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text y="9" x="0" dy=".71em" style="text-anchor: middle;">June</text></g><g class="tick" transform="translate(668.8107202680067,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text y="9" x="0" dy=".71em" style="text-anchor: middle;">July</text></g><g class="tick" transform="translate(812.1273031825796,0)" style="opacity: 1;"><line y2="6" x2="0"></line><text y="9" x="0" dy=".71em" style="text-anchor: middle;">August</text></g><path class="domain" d="M0,6V0H920V6"></path></g><g class="y axis"><g class="tick" transform="translate(0,142.22222222222223)" style="opacity: 1;"><line x2="-6" y2="0"></line><text x="-9" y="0" dy=".32em" style="text-anchor: end;">20</text></g><g class="tick" transform="translate(0,106.66666666666666)" style="opacity: 1;"><line x2="-6" y2="0"></line><text x="-9" y="0" dy=".32em" style="text-anchor: end;">40</text></g><g class="tick" transform="translate(0,71.11111111111111)" style="opacity: 1;"><line x2="-6" y2="0"></line><text x="-9" y="0" dy=".32em" style="text-anchor: end;">60</text></g><g class="tick" transform="translate(0,35.55555555555556)" style="opacity: 1;"><line x2="-6" y2="0"></line><text x="-9" y="0" dy=".32em" style="text-anchor: end;">80</text></g><g class="tick" transform="translate(0,0)" style="opacity: 1;"><line x2="-6" y2="0"></line><text x="-9" y="0" dy=".32em" style="text-anchor: end;">100</text></g><path class="domain" d="M-6,0H0V160H-6"></path></g><text class="y label" text-anchor="end" y="6" dy=".75em" transform="rotate(-90)">DISTINCT</text><path class="line" d="M920,133.33333333333331L915.3768844221105,99.55555555555556L910.7537688442211,74.66666666666667L906.1306532663317,99.55555555555556L901.5075376884422,119.11111111111111L896.8844221105528,53.333333333333314L892.2613065326633,90.66666666666666L887.6381909547738,129.77777777777777L883.0150753768845,74.66666666666667L878.391959798995,69.33333333333334L873.7688442211055,0L869.1457286432161,87.11111111111111L864.5226130653266,112L859.8994974874372,117.33333333333334L855.2763819095478,108.44444444444444L850.6532663316583,151.11111111111111L846.0301507537688,55.111111111111114L841.4070351758794,97.77777777777777L836.78391959799,64L832.1608040201005,99.55555555555556L827.5376884422111,76.44444444444444L822.9145728643216,108.44444444444444L818.2914572864321,113.77777777777777L813.6683417085428,65.77777777777777L809.0452261306533,69.33333333333334L804.4221105527638,65.77777777777777L799.7989949748744,99.55555555555556L795.1758793969849,60.44444444444444L790.5527638190955,92.44444444444444L785.9296482412061,76.44444444444444L781.3065326633166,78.22222222222221L776.6834170854271,87.11111111111111L772.0603015075377,67.55555555555554L767.4371859296483,72.88888888888889L762.8140703517588,104.88888888888889L758.1909547738694,115.55555555555556L753.5678391959799,144L748.9447236180904,62.222222222222214L744.321608040201,74.66666666666667L739.6984924623116,40.888888888888886L735.0753768844221,90.66666666666666L730.4522613065327,106.66666666666666L725.8291457286432,92.44444444444444L721.2060301507537,112L716.5829145728644,88.88888888888889L711.9597989949749,74.66666666666667L707.3366834170854,71.11111111111111L702.713567839196,76.44444444444444L698.0904522613065,49.77777777777777L693.4673366834171,135.11111111111111L688.8442211055277,101.33333333333333L684.2211055276382,88.88888888888889L679.5979899497487,76.44444444444444L674.9748743718593,96L670.3517587939699,49.77777777777777L665.7286432160804,23.111111111111086L661.105527638191,128L656.4824120603015,119.11111111111111L651.859296482412,96L647.2361809045227,24.888888888888886L642.6130653266332,49.77777777777777L637.9899497487437,0L633.3668341708543,90.66666666666666L628.7437185929648,101.33333333333333L624.1206030150754,112L619.497487437186,104.88888888888889L614.8743718592965,131.55555555555554L610.251256281407,92.44444444444444L605.6281407035176,122.66666666666666L601.0050251256282,113.77777777777777L596.3819095477387,76.44444444444444L591.7587939698493,64L587.1356783919598,88.88888888888889L582.5125628140703,42.66666666666666L577.8894472361809,83.55555555555556L573.2663316582915,90.66666666666666L568.643216080402,96L564.0201005025126,81.77777777777777L559.3969849246231,62.222222222222214L554.7738693467337,92.44444444444444L550.1507537688442,133.33333333333331L545.5276381909548,142.22222222222223L540.9045226130653,97.77777777777777L536.2814070351759,78.22222222222221L531.6582914572864,144L527.035175879397,145.77777777777777L522.4120603015076,136.88888888888889L517.7889447236181,136.88888888888889L513.1658291457286,97.77777777777777L508.54271356783914,106.66666666666666L503.9195979899498,81.77777777777777L499.2964824120603,104.88888888888889L494.67336683417085,106.66666666666666L490.0502512562814,88.88888888888889L485.4271356783919,81.77777777777777L480.80402010050256,51.55555555555554L476.1809045226131,88.88888888888889L471.5577889447236,103.11111111111111L466.93467336683415,90.66666666666666L462.3115577889447,83.55555555555556L457.68844221105525,90.66666666666666L453.06532663316585,67.55555555555554L448.4422110552764,67.55555555555554L443.8190954773869,81.77777777777777L439.1959798994975,83.55555555555556L434.57286432160805,72.88888888888889L429.9497487437186,69.33333333333334L425.32663316582915,56.888888888888886L420.7035175879397,110.22222222222223L416.08040201005025,94.22222222222221L411.4572864321608,74.66666666666667L406.8341708542714,87.11111111111111L402.2110552763819,160L388.34170854271355,76.44444444444444L383.71859296482415,128L379.0954773869347,94.22222222222221L374.4723618090452,112L369.8492462311558,71.11111111111111L365.22613065326635,103.11111111111111L360.60301507537685,97.77777777777777L355.97989949748745,58.66666666666667L351.356783919598,58.66666666666667L346.73366834170855,49.77777777777777L342.1105527638191,113.77777777777777L337.48743718592965,53.333333333333314L332.8643216080402,10.666666666666657L328.24120603015075,47.999999999999986L323.61809045226136,69.33333333333334L318.99497487437185,26.666666666666657L314.3718592964824,53.333333333333314L309.748743718593,53.333333333333314L305.1256281407035,47.999999999999986L300.5025125628141,56.888888888888886L295.87939698492465,80L291.25628140703515,19.555555555555543L286.63316582914575,76.44444444444444L282.0100502512563,108.44444444444444L277.38693467336685,113.77777777777777L272.7638190954774,104.88888888888889L268.14070351758795,55.111111111111114L263.5175879396985,76.44444444444444L258.89447236180905,76.44444444444444L254.27135678391957,88.88888888888889L249.64824120603015,108.44444444444444L245.0251256281407,87.11111111111111L240.40201005025128,64L235.7788944723618,71.11111111111111L231.15577889447235,88.88888888888889L226.53266331658293,96L221.90954773869345,101.33333333333333L217.28643216080403,104.88888888888889L212.66331658291458,108.44444444444444L208.04020100502512,16L203.4170854271357,110.22222222222223L198.79396984924622,115.55555555555556L194.17085427135677,87.11111111111111L189.54773869346735,83.55555555555556L184.9246231155779,122.66666666666666L180.30150753768842,88.88888888888889L175.678391959799,80L171.05527638190955,78.22222222222221L166.4321608040201,88.88888888888889L161.80904522613068,108.44444444444444L157.1859296482412,83.55555555555556L152.56281407035175,62.222222222222214L147.93969849246233,96L143.31658291457288,97.77777777777777L138.69346733668343,78.22222222222221L134.07035175879398,80L129.44723618090453,85.33333333333333L124.82412060301507,76.44444444444444L120.20100502512564,88.88888888888889L115.57788944723617,83.55555555555556L110.95477386934672,83.55555555555556L106.33165829145729,90.66666666666666L101.70854271356785,88.88888888888889L97.08542713567839,69.33333333333334L92.46231155778895,55.111111111111114L87.8391959798995,16L83.21608040201005,46.222222222222214L78.5929648241206,14.222222222222229L73.96984924623116,28.44444444444443L69.34673366834171,128L64.72361809045226,88.88888888888889L60.10050251256282,112L55.47738693467336,108.44444444444444L50.854271356783926,87.11111111111111L46.231155778894475,103.11111111111111L41.608040201005025,99.55555555555556L36.98492462311558,85.33333333333333L32.36180904522613,140.44444444444446L27.73869346733668,96L23.115577889447238,106.66666666666666L18.49246231155779,96L13.86934673366834,90.66666666666666L9.246231155778895,71.11111111111111L4.623115577889448,122.66666666666666L0,76.44444444444444"></path></g></svg></p>
<p>一天居然能上千条命令。</p>
<p>现在InfluxDB的画图工具还不完善，要把两条曲线放同一个图里都不行，Influga和Grafana也很多bug，所以还是把结果导出来，再用其他工具画图，还是先不浪费时间了。</p>
<style>
.line {
    fill: none;
    stroke: #4682B4;
    stroke-width: 1.5px;
}
.label {
    font-weight: normal;
    font-family: "Helvetica Neue","Helvetica",Helvetica,Arial,sans-serif;
    text-align: center;
    text-decoration: none;
    line-height: 1;
    white-space: nowrap;
    display: inline-block;
    position: relative;
    margin-bottom: inherit;
    padding: 0.25rem 0.5rem 0.375rem;
    font-size: 0.6875rem;
    background-color: #008CBA;
    color: #FFF;
}
.axis path, .axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispedges;
}
</style>


  </section>

  <section id="comment">
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </section>

</article>

<script type="text/javascript" src="../js/post.js"></script>


    </div>
    <footer id="footer">
      @mgampkay
    </footer>

    <script type="text/javascript" src="../js/ga.js"></script>

  </body>
</html>
